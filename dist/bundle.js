!function(e,o){"object"==typeof exports&&"object"==typeof module?module.exports=o():"function"==typeof define&&define.amd?define("ConvivialProfiler",[],o):"object"==typeof exports?exports.ConvivialProfiler=o():e.ConvivialProfiler=o()}(self,(function(){return function(){"use strict";var e={d:function(o,t){for(var r in t)e.o(t,r)&&!e.o(o,r)&&Object.defineProperty(o,r,{enumerable:!0,get:t[r]})},o:function(e,o){return Object.prototype.hasOwnProperty.call(e,o)},r:function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})}},o={};function t(e,o,t){t.forEach((function(e){window.convivialProfiler._increaseValue("accumulators",o.storage_key,e)}))}function r(e,o,t){t.forEach((function(e){o.normalize?window.convivialProfiler._increaseSubValue("dimensions",o.storage_key,e,1/t.length):window.convivialProfiler._increaseSubValue("dimensions",o.storage_key,e)}))}function i(e,o,t){t.forEach((function(e){window.convivialProfiler._setValue("fetchers",o.storage_key,{value:e,expire:window.convivialProfiler._getTime()+o.ttl})}))}function a(e,o,t){var r=window.convivialProfiler._getTime()+o.ttl;null!==o.ttl&&o.ttl>0&&(r=window.convivialProfiler._getTime()-1),t.forEach((function(e){window.convivialProfiler._setValue("store",o.storage_key,{value:e.toLowerCase(),expire:r})}))}function n(e,o,t){var r=window.convivialProfiler._getTime()+o.ttl;null!==o.ttl&&o.ttl>0&&(r=window.convivialProfiler._getTime()-1),t.forEach((function(e){window.convivialProfiler._setValue("store",o.storage_key,{value:e.split("-")[0].toLowerCase(),expire:r})}))}function l(e,o,t){if(t&&t.length>0&&t[0]&&o.mappings&&o.mappings.length>0){var r=o.mappings.filter((function(e){return e.includes(t[0]+"|")}));r&&r.length>0&&r[0]?window.convivialProfiler._setValue("store",o.storage_key,{value:r[0].replace(t[0]+"|",""),expire:window.convivialProfiler._getTime()}):window.convivialProfiler._setValue("store",o.storage_key,{value:o.fallback_value,expire:window.convivialProfiler._getTime()})}else window.convivialProfiler._setValue("store",o.storage_key,{value:o.default_value,expire:window.convivialProfiler._getTime()})}function s(e,o,t){!0===o.log&&window.convivialProfiler._logValue(o.storage_key,[window.location.href,window.convivialProfiler._getTime()]),!0===o.track&&window.convivialProfiler._increaseValue("counters",o.storage_key)}function c(e,o,t){if(window.location.pathname.includes(o.search_path)&&window.location.search.substring(1).length>0){var r=[],i="";if(window.location.search.substring(1).split("&").forEach((function(e){r.push(e.split("=")[0]),e.split("=")[0]===o.query_param&&(i=e.split("=")[1])})),r.includes(o.query_param)&&!r.includes(o.exclude_param)&&""!==i){var a=window.convivialProfiler._getValue("log."+o.storage_key)||[],n=i.split("+").join(" ");void 0===a.find((function(e){return e.title==n}))&&(!0===o.log&&window.convivialProfiler._logValue(o.storage_key,{title:n,url:window.location.href},o.size),!0===o.track&&window.convivialProfiler._increaseValue("counters",o.storage_key))}}}function u(e,o,t){var r=window.convivialProfiler._getTime()+o.ttl;null!==o.ttl&&o.ttl<1&&(r=window.convivialProfiler._getTime()-1),t.forEach((function(e){window.convivialProfiler._setValue("store",o.storage_key,{value:e,expire:r})}))}function f(e,o,t){t.forEach((function(e){window.convivialProfiler._setValue("temp",o.storage_key,{value:e})}))}function g(e,o,t){var r=[];o.storage_keys.forEach((function(e){var o=localStorage.getItem(e);void 0!==o&&r.push(o)})),r=r.filter((function(e){return null!=e&&""!=e})),Array.isArray(r)&&0===r.length&&o.default_value&&void 0!==o.default_value&&r.push(o.default_value),r.length?("localstorage"===o.target_location.localstorage&&r[0]&&localStorage.setItem(o.target_key,r[0]),"cookie"===o.target_location.cookie&&r[0]&&window.convivialProfiler._setCookie(o.target_key,r[0])):o.remove_empty&&!r.length&&localStorage.removeItem(o.target_key)}function v(e,o,t){var r=window.convivialProfiler._getValue(o.storage_key);r?(void 0!==o.stringify&&o.stringify&&(r=JSON.stringify(r)),"localstorage"===o.target_location.localstorage&&localStorage.setItem(o.target_key,r),"cookie"===o.target_location.cookie&&window.convivialProfiler._setCookie(o.target_key,r)):o.remove_empty&&!r&&localStorage.removeItem(o.target_key)}function p(e,o,t){t.forEach((function(e){window.dataLayer=window.dataLayer||[],window.dataLayer.push({event:"convivialProfiler.event",category:o.category,action:o.action,label:e,value:o.normalize?1/t.length:1})}))}function d(e,o,t){var r="form"+o.form_selector,i=document.querySelector(r);null!==i&&o.fields_selector.forEach((function(e){var t=e.split("|")[0],r=e.split("|")[1];null!==i.querySelector('input[name="'+t+'"]')&&null!==r&&("localstorage"===o.storage_source.localstorage&&(i.querySelector('input[name="'+t+'"]').value=localStorage.getItem(r)),"cookie"===o.storage_source.cookie&&(i.querySelector('input[name="'+t+'"]').value=window.convivialProfiler._getCookie(r)))}))}function h(e,o,t){var r="form"+o.form_selector,i=document.querySelector(r);function a(e){var t="form"+o.form_selector+' input[name="'+o.field_name+'"]',r=document.querySelector(t).value;"radio"!==document.querySelector(t).type&&"checkbox"!==document.querySelector(t).type||null!=document.querySelector(t+":checked")&&(r=document.querySelector(t+":checked").value),window.dataLayer=window.dataLayer||[],window.dataLayer.push({event:"convivialProfiler.event",category:o.event_category,action:o.event_action,label:r,value:1})}null!==i&&(i.addEventListener?i.addEventListener("submit",a,!1):i.attachEvent&&i.attachEvent("onsubmit",a))}function _(e,o,t){var r=new Date,i=o.daylight_saving_offset;r.getTime()>=Date.parse(o.normal_start)&&r.getTime()<=Date.parse(o.normal_end)&&(i=o.normal_offset);var a=new Date(r.getUTCFullYear(),r.getUTCMonth(),r.getUTCDate(),r.getUTCHours(),r.getUTCMinutes(),r.getUTCSeconds(),r.getUTCMilliseconds()).getTime()+36e5*i,n=new Date(a),l=n.getDay(),s=0;if(o.office_times){var c=o.office_times.filter((function(e){return l===e.day}));c&&c.length>0&&c.forEach((function(e){s=n.getHours()>=parseInt(e.start)&&n.getHours()<=parseInt(e.close)?1:0}))}"localstorage"===o.target_location.localstorage&&localStorage.setItem(o.target_key,s),"cookie"===o.target_location.cookie&&window.convivialProfiler._setCookie(o.target_key,s)}function y(e,o,t){var r=window.convivialProfiler._getValue(o.storage_key);r?o.ranges.forEach((function(e){r>=e.min&&r<e.max&&("localstorage"===o.target_location.localstorage&&localStorage.setItem(o.target_key,e.key),"cookie"===o.target_location.cookie&&window.convivialProfiler._setCookie(o.target_key,e.key))})):o.remove_empty&&!r&&localStorage.removeItem(o.target_key)}function m(e,o,t){var r=[];o.storage_keys.forEach((function(e){var o=window.convivialProfiler._getValue(e);void 0!==o&&r.push(o)})),r.length&&(r=r.filter((function(e){return null!=e&&""!=e})),Array.isArray(r)&&o.static_values&&void 0!==o.static_values&&o.static_values.forEach((function(e){void 0!==e&&r.push(e)})),r.forEach((function(e){"localstorage"===o.target_location.localstorage&&localStorage.removeItem(e),"cookie"===o.target_location.cookie&&window.convivialProfiler._setCookie(e,"",0)})))}function w(e,o,t){var r=window.convivialProfiler._getValue(o.storage_key);if(r){var i=["winter","winter","spring","spring","spring","summer","summer","summer","autumn","autumn","autumn","winter"],a=r<0?6:0,n=((new Date).getMonth()+a)%12;"localstorage"===o.target_location.localstorage&&localStorage.setItem(o.target_key,i[n]),"cookie"===o.target_location.cookie&&window.convivialProfiler._setCookie(o.target_key,i[n])}else o.remove_empty&&!r&&localStorage.removeItem(o.target_key)}function k(e,o,t){var r=window.convivialProfiler._getValue(o.storage_key);r&&("localstorage"===o.target_location.localstorage&&localStorage.setItem(r,"1"),"cookie"===o.target_location.cookie&&window.convivialProfiler._setCookie(r,"1"))}function P(e,o,t){var r=window.convivialProfiler._getValue(o.storage_key);if(r&&r>=o.threshold_number&&("localstorage"===o.target_location.localstorage&&localStorage.setItem(o.target_key,o.target_value),"cookie"===o.target_location.cookie)){var i=new Date(Date.now()+864e5).toUTCString();document.cookie=o.target_key+"="+encodeURIComponent(o.target_value)+";path=/;expires="+i}}function S(e,o,t){var r=window.convivialProfiler._getValue(o.dimension_key);if(r){var i=null,a=null;for(var n in r)(null===a||r[n]>a)&&(i=n,a=r[n]);"localstorage"===o.target_location.localstorage&&localStorage.setItem(o.target_key,i),"cookie"===o.target_location.cookie&&window.convivialProfiler._setCookie(o.target_key,i)}else o.remove_empty&&!r&&localStorage.removeItem(o.target_key)}function b(e,o,t){var r=window.convivialProfiler._getValue(o.storage_key);r&&("localstorage"===o.target_location.localstorage&&localStorage.setItem(r,"0"),"cookie"===o.target_location.cookie&&window.convivialProfiler._setCookie(r,"0"))}function I(e,o){(null==o||o>e.length)&&(o=e.length);for(var t=0,r=new Array(o);t<o;t++)r[t]=e[t];return r}function C(e,o,t){null!==navigator.language&&navigator.language.includes("-")?t.push(navigator.language):t.push("en-AU")}function V(e,o,t){var r=window.convivialProfiler._getCookie(o.name);null!==r&&t.push(r)}function D(e,o,t){var r=new XMLHttpRequest;r.onload=function(){try{t.push(JSON.parse(r.response)),window.convivialProfiler._processValues(e,t)}catch(e){r.onerror()}},r.onerror=function(){console.debug('Unable to fetch values of "'+o.resource_url+'".')},r.open("GET",o.resource_url),r.send()}function T(e,o,t){/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)?t.push("mobile"):t.push("desktop")}function E(e,o,t){var r,i=function(e,o){var t="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!t){if(Array.isArray(e)||(t=function(e,o){if(e){if("string"==typeof e)return I(e,o);var t=Object.prototype.toString.call(e).slice(8,-1);return"Object"===t&&e.constructor&&(t=e.constructor.name),"Map"===t||"Set"===t?Array.from(e):"Arguments"===t||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(t)?I(e,o):void 0}}(e))||o&&e&&"number"==typeof e.length){t&&(e=t);var r=0,i=function(){};return{s:i,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var a,n=!0,l=!1;return{s:function(){t=t.call(e)},n:function(){var e=t.next();return n=e.done,e},e:function(e){l=!0,a=e},f:function(){try{n||null==t.return||t.return()}finally{if(l)throw a}}}}(document.querySelectorAll('meta[name="'+o.attribute_name+'"]'));try{for(i.s();!(r=i.n()).done;){var a=r.value;t.push(a.getAttribute("content"))}}catch(e){i.e(e)}finally{i.f()}}function x(e,o,t){window.location.search.substring(1).split("&").forEach((function(e){var r=e.split("=");if(r[0]===o.param||r[0]===o.param+"[]"){var i=decodeURIComponent(r[1].replace(/\+/g," "));t.push(void 0===r[1]||i)}}))}function A(e,o,t){"hour"===o.part?t.push((new Date).getHours()):"minute"===o.part?t.push((new Date).getMinutes()):"second"===o.part&&t.push((new Date).getSeconds())}function O(e,o){for(var t=0;t<o.length;t++){var r=o[t];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}e.r(o),e.d(o,{default:function(){return U}});var U=function(){function e(o,I,O,U){!function(e,o){if(!(e instanceof o))throw new TypeError("Cannot call a class as a function")}(this,e),this.version=1,this.config=o,this.siteId=I,this.licenseKey=O,this.clientId=U||this.getClientId(),this.storage=this._loadStorage(),this.storage.temp={},window.convivialProfiler=window.convivialProfiler||{},this.profilerSource={},this.profilerSource.acceptlang=C,this.profilerSource.cookie=V,this.profilerSource.get=D,this.profilerSource.meta=E,this.profilerSource.query=x,this.profilerSource.time=A,this.profilerSource.httpuseragent=T,this.profilerProcessor={},this.profilerProcessor.accumulation=t,this.profilerProcessor.dimension=r,this.profilerProcessor.extreme_geoip=i,this.profilerProcessor.language_simple=n,this.profilerProcessor.language_full=a,this.profilerProcessor.map=l,this.profilerProcessor.pageview=s,this.profilerProcessor.searchquery=c,this.profilerProcessor.store=u,this.profilerProcessor.temp=f,this.profilerDestination={},this.profilerDestination.bestpick=g,this.profilerDestination.copy=v,this.profilerDestination.datalayer_event=p,this.profilerDestination.formfiller=d,this.profilerDestination.formtracker=h,this.profilerDestination.officehours=_,this.profilerDestination.range=y,this.profilerDestination.remove=m,this.profilerDestination.season=w,this.profilerDestination.set=k,this.profilerDestination.threshold=P,this.profilerDestination.top=S,this.profilerDestination.unset=b}var o,I;return o=e,(I=[{key:"getClientId",value:function(){var e=this._getCookie("ConvivialProfilerClientId");if(null===e){var o=new Uint8Array(10);(window.crypto||window.msCrypto).getRandomValues(o),e="";for(var t=0;t<o.length;t++)e+=("0"+o[t].toString(16)).substr(-2);this._setCookie("ConvivialProfilerClientId",e,365)}return e}},{key:"track",value:function(e,o){this._increaseValue("counters",e),this._logValue(e,[o,this._getTime()])}},{key:"collect",value:function(){var e=this,o=this._getTime();if(Object.keys(this.config.profilers).forEach((function(t){var r=e.config.profilers[t];if(r.deferred){var i=e._getValue("fetchers."+t);if(void 0!==i&&i.expire>o)return}var a=[];r.sources.forEach((function(o){void 0!==e.profilerSource[o.type]?e.profilerSource[o.type](r,o,a):console.debug('Invalid profiler source type "'+o.type+'".')})),e._processValues(r,a),r.destinations.forEach((function(o){void 0!==e.profilerDestination[o.type]?e.profilerDestination[o.type](r,o,a):console.debug('Invalid profiler destination type "'+o.type+'".')}))})),void 0!==this._getValue("store")){for(var t in this.storage.store)this.storage.store.hasOwnProperty(t)&&this.storage.store[t].expire<o&&delete this.storage.store[t];this._saveStorage()}}},{key:"_processValues",value:function(e,o){var t=this;e.processors.forEach((function(r){void 0!==t.profilerProcessor[r.type]?t.profilerProcessor[r.type](e,r,o):console.debug('Invalid profiler processor type "'+r.type+'".')}))}},{key:"_loadStorage",value:function(){var e=JSON.parse(localStorage.getItem("convivial_profiler"))||{};return!0===this._getConfig("client_cleanup")&&e._clientId!==this.clientId?(localStorage.removeItem("convivial_profiler"),{}):e[this.siteId]||{}}},{key:"_saveStorage",value:function(){var e=JSON.parse(localStorage.getItem("convivial_profiler"))||{};e._clientId=this.clientId,e._version=this.version,e._licenseKey=this.licenseKey,e[this.siteId]=this.storage,localStorage.setItem("convivial_profiler",JSON.stringify(e))}},{key:"_getValue",value:function(e,o){return o=o||this.storage,(Array.isArray(e)?e:e.split(".")).reduce((function(e,o){return e&&e[o]}),o)}},{key:"_getConfig",value:function(e){return this._getValue(e,this.config)}},{key:"_setValue",value:function(e,o,t){this.storage[e]=this.storage[e]||{},this.storage[e][o]=t,this._saveStorage()}},{key:"_increaseValue",value:function(e,o,t){this.storage[e]=this.storage[e]||{},this.storage[e][o]=this.storage[e][o]||0,this.storage[e][o]+=parseFloat(t)||1,this._saveStorage()}},{key:"_increaseSubValue",value:function(e,o,t,r){this.storage[e]=this.storage[e]||{},this.storage[e][o]=this.storage[e][o]||{},this.storage[e][o][t]=this.storage[e][o][t]||0,this.storage[e][o][t]+=parseFloat(r)||1,this._saveStorage()}},{key:"_logValue",value:function(e,o,t){this.storage.log=this.storage.log||{},this.storage.log[e]=this.storage.log[e]||[],void 0!==t&&this.storage.log[e].length==t&&this.storage.log[e].shift(),this.storage.log[e].push(o),this._saveStorage()}},{key:"_getTime",value:function(){return Math.round((new Date).getTime()/1e3)}},{key:"_getCookie",value:function(e){var o=document.cookie.match("(^|;) ?"+e+"=([^;]*)(;|$)");return o?decodeURIComponent(o[2]):null}},{key:"_setCookie",value:function(e,o,t){var r=new Date(Date.now()+864e5*t).toUTCString();document.cookie=e+"="+encodeURIComponent(o)+";path=/;expires="+r}}])&&O(o.prototype,I),Object.defineProperty(o,"prototype",{writable:!1}),e}();return o}()}));